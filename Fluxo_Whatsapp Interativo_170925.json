{
  "name": "Whatsapp Interativo",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "whatsapp-interativo-webhook",
        "responseMode": "responseNode",
        "options": {}
      },
      "id": "6f1db9ef-5358-4208-ae78-5d640de6d679",
      "name": "Webhook WhatsApp Interativo",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [
        -1808,
        -304
      ],
      "webhookId": "whatsapp-interativo-webhook"
    },
    {
      "parameters": {
        "options": {}
      },
      "id": "b4b62734-f302-4786-aa13-382997767048",
      "name": "Processar Mensagem",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3,
      "position": [
        -1584,
        -304
      ]
    },
    {
      "parameters": {
        "url": "https://rfrzxobijhrcfixtauft.supabase.co/rest/v1/usuarios",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "select",
              "value": "*"
            },
            {
              "name": "telefone_whatsapp",
              "value": "eq.{{ $json.telefone }}"
            }
          ]
        },
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJmcnp4b2JpamhyY2ZpeHRhdWZ0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTcwOTkyMTYsImV4cCI6MjA3MjY3NTIxNn0.83p6u1ZIW_1rpanj5cD054faD0TOw-79FLnitQrJi2c"
            },
            {
              "name": "apikey",
              "value": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJmcnp4b2JpamhyY2ZpeHRhdWZ0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTcwOTkyMTYsImV4cCI6MjA3MjY3NTIxNn0.83p6u1ZIW_1rpanj5cD054faD0TOw-79FLnitQrJi2c"
            }
          ]
        },
        "options": {}
      },
      "id": "fa0ac05e-30e9-407e-806c-c12d556128f2",
      "name": "Verificar Usu√°rio Existente",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4,
      "position": [
        -1360,
        -304
      ],
      "alwaysOutputData": true,
      "retryOnFail": true
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 1
          },
          "conditions": [
            {
              "id": "usuario_existe",
              "leftValue": "={{ $('Verificar Usu√°rio Existente').json }}",
              "rightValue": "0",
              "operator": {
                "type": "string",
                "operation": "notEquals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "0a610549-5912-4d13-952a-3298f0fad6bf",
      "name": "Usu√°rio Existe?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        -1136,
        -304
      ],
      "retryOnFail": true,
      "alwaysOutputData": true
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "tem_supermercados",
              "leftValue": "={{ $json[0].supermercados_preferidos && $json[0].supermercados_preferidos.length }}",
              "rightValue": 0,
              "operator": {
                "type": "number",
                "operation": "gt"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "dc2341cd-ee1e-4103-9ac4-3a70dd22a040",
      "name": "Tem Supermercados?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        -928,
        -400
      ]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": false,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "ofertas_cmd",
              "leftValue": "={{ $('Processar Mensagem' ).item.json.mensagem }}",
              "rightValue": "ofertas",
              "operator": {
                "type": "string",
                "operation": "contains"
              }
            }
          ],
          "combinator": "or"
        },
        "options": {}
      },
      "id": "4ca57c94-5981-4271-aeaf-b580e7f22bbf",
      "name": "√â Comando Ofertas?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        -704,
        -640
      ]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": false,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "plano_basico",
              "leftValue": "={{ $('Processar Mensagem').item.json.mensagem }}",
              "rightValue": "plano basico",
              "operator": {
                "type": "string",
                "operation": "contains"
              }
            },
            {
              "id": "plano_premium",
              "leftValue": "={{ $('Processar Mensagem').item.json.mensagem }}",
              "rightValue": "plano premium",
              "operator": {
                "type": "string",
                "operation": "contains"
              }
            }
          ],
          "combinator": "or"
        },
        "options": {}
      },
      "id": "c58abbfd-a3fa-4f5c-9332-80470f5e367e",
      "name": "√â Comando Plano?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        -704,
        -256
      ]
    },
    {
      "parameters": {
        "url": "https://rfrzxobijhrcfixtauft.supabase.co/functions/v1/ofertas-personalizadas",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJmcnp4b2JpamhyY2ZpeHRhdWZ0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTcwOTkyMTYsImV4cCI6MjA3MjY3NTIxNn0.83p6u1ZIW_1rpanj5cD054faD0TOw-79FLnitQrJi2c"
            },
            {
              "name": "apikey",
              "value": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJmcnp4b2JpamhyY2ZpeHRhdWZ0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTcwOTkyMTYsImV4cCI6MjA3MjY3NTIxNn0.83p6u1ZIW_1rpanj5cD054faD0TOw-79FLnitQrJi2c"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ {\n  \"telefone\": $('Processar Mensagem' ).item.json.telefone,\n  \"plano\": $('Verificar Usu√°rio Existente').item.json[0].plano,\n  \"limite_ofertas\": $('Verificar Usu√°rio Existente').item.json[0].plano === 'basico' ? '5' : 'ilimitado'\n} }}",
        "options": {}
      },
      "id": "6b5203c9-3089-41cb-a4ba-e4fe69bb1450",
      "name": "Buscar Ofertas",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4,
      "position": [
        -480,
        -704
      ]
    },
    {
      "parameters": {
        "options": {}
      },
      "id": "4d2ebeff-4deb-4941-a604-c34a533ef9df",
      "name": "Identificar Plano",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3,
      "position": [
        -480,
        -512
      ]
    },
    {
      "parameters": {
        "url": "{{ $('Webhook WhatsApp Interativo').item.json.n8n_base_url || 'http://localhost:5678' }}/webhook/gestao-planos",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ {\n  \"acao\": \"assinar_plano\",\n  \"telefone\": $('Processar Mensagem' ).item.json.telefone,\n  \"plano_escolhido\": $json.plano_escolhido,\n  \"cpf_usuario\": $('Verificar Usu√°rio Existente').item.json[0].cpf\n} }}",
        "options": {}
      },
      "id": "025e73a2-a93c-4f9a-a5ce-7157b1eb1857",
      "name": "Chamar Gest√£o Planos",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4,
      "position": [
        -256,
        -432
      ]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": false,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "cadastro_cmd",
              "leftValue": "={{ $('Processar Mensagem').item.json.mensagem }}",
              "rightValue": "cadastro",
              "operator": {
                "type": "string",
                "operation": "contains"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "ad6f9251-e4d9-4933-a30d-9767b12edc10",
      "name": "√â Comando Cadastro?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        -688,
        -48
      ]
    },
    {
      "parameters": {
        "options": {}
      },
      "id": "6ad5007f-61df-4a82-a06d-dccb9f1f1174",
      "name": "Extrair Dados Cadastro",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3,
      "position": [
        -464,
        -80
      ]
    },
    {
      "parameters": {
        "url": "https://rfrzxobijhrcfixtauft.supabase.co/functions/v1/usuarios-whatsapp",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJmcnp4b2JpamhyY2ZpeHRhdWZ0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTcwOTkyMTYsImV4cCI6MjA3MjY3NTIxNn0.83p6u1ZIW_1rpanj5cD054faD0TOw-79FLnitQrJi2c"
            },
            {
              "name": "apikey",
              "value": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJmcnp4b2JpamhyY2ZpeHRhdWZ0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTcwOTkyMTYsImV4cCI6MjA3MjY3NTIxNn0.83p6u1ZIW_1rpanj5cD054faD0TOw-79FLnitQrJi2c"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ {\n  \"telefone\": $('Processar Mensagem' ).item.json.telefone,\n  \"cep\": $json.cep_informado,\n  \"cpf\": $json.cpf_informado,\n  \"formato_preferido\": \"Texto\"\n} }}",
        "options": {}
      },
      "id": "275a8d20-7da3-4465-bda2-7e2906e77438",
      "name": "Executar Cadastro",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4,
      "position": [
        -240,
        -192
      ]
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ {\n  \"status\": \"processed\",\n  \"action\": \"whatsapp_interaction\",\n  \"user_exists\": $('Verificar Usu√°rio Existente').item.json.length > 0\n} }}",
        "options": {}
      },
      "id": "a54b8349-f307-4762-9619-53485ac3a6b2",
      "name": "Resposta Webhook",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [
        368,
        -304
      ]
    },
    {
      "parameters": {
        "url": "http://evolution-api:8080/message/sendText/Dona Oferta",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"number\": \"{{ $('Processar Mensagem').item.json.telefone }}\",\n  \"textMessage\": {\n    \"text\": \"üëã *Ol√°! Bem-vindo √† Dona Oferta!*\\n\\nüéâ Que bom ter voc√™ aqui!\\n\\nüÜì *TRIAL GRATUITO DE 60 DIAS!*\\nPara come√ßar a receber as melhores ofertas, preciso de algumas informa√ß√µes:\\n\\nüì± Seu telefone: {{ $('Processar Mensagem').item.json.telefone }} ‚úÖ\\nüìÆ Seu CEP\\nüÜî Seu CPF\\n\\nPor favor, envie no formato:\\n*CADASTRO [SEU_CEP] [SEU_CPF]*\\n\\nExemplo: *CADASTRO 01234567 123.456.789-00*\\n\\nüí° Ap√≥s o cadastro, voc√™ ter√° 60 dias gratuitos para testar todas as funcionalidades!\"\n  }\n}\n",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -896,
        -80
      ],
      "id": "9317066b-6630-4ce7-ac8d-51f78131fe50",
      "name": "Iniciar Cadastro Novo",
      "credentials": {
        "httpHeaderAuth": {
          "id": "qFt2p2U8faEpGTz6",
          "name": "Credencial Evolution"
        }
      }
    },
    {
      "parameters": {
        "method": "POST",
        "url": "http://evolution-api:8080/message/sendText/Dona Oferta",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "apikey",
              "value": "tkA3TYVBvfq42QBCaA11WqzuGaaUO11ZUs06XImXvnlqLDNjOYwVlRDJs9iJmeBx"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"number\": \"{{ $('Webhook WhatsApp Interativo').item.json.body.data.key.remoteJid }}\",\n  \"text\": \"üõí *Bem-vindo de volta!*\\n\\nVoc√™ j√° est√° cadastrado com trial ativo! ‚úÖ\\n\\nüìã *Pr√≥ximo passo:* Precisamos que voc√™ escolha seus supermercados preferidos.\\n\\nPor favor, nos informe:\\nüìç Qual regi√£o/cidade voc√™ mora?\\nüè™ Quais supermercados voc√™ frequenta?\\n\\nExemplo: *Moro em S√£o Paulo, frequento Carrefour e P√£o de A√ß√∫car*\\n\\nüí° Ap√≥s isso, voc√™ receber√° ofertas personalizadas!\"\n}\n",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -480,
        -336
      ],
      "id": "a5160c9e-5e51-45a9-b914-82b1e6f07538",
      "name": "Solicitar Supermercados"
    },
    {
      "parameters": {
        "url": "http://evolution-api:8080/message/sendText/Dona Oferta",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"number\": \"{{ $('Processar Mensagem').item.json.telefone }}\",\n  \"textMessage\": {\n    \"text\": \"üîÑ *Intera√ß√£o processada*\\n\\n{{ $('Processar Mensagem').item.json.mensagem_original }}\\n\\n---\\nüí° *Comandos dispon√≠veis:*\\n\\nüõí *OFERTAS* - Receber ofertas do dia\\nüíé *PLANO BASICO* ou *PLANO PREMIUM* - Assinar planos\\nüìù *CADASTRO [CEP] [CPF]* - Para novos usu√°rios\\n\\n‚ùì Para d√∫vidas, apenas envie uma mensagem!\"\n  }\n}\n",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -464,
        112
      ],
      "id": "1005bd04-a72f-4ac4-b7f3-f2e4ccc4bcad",
      "name": "Resposta Gen√©rica1",
      "credentials": {
        "httpHeaderAuth": {
          "id": "qFt2p2U8faEpGTz6",
          "name": "Credencial Evolution"
        }
      }
    },
    {
      "parameters": {
        "url": "http://evolution-api:8080/message/sendText/Dona Oferta",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"number\": \"{{ $('Processar Mensagem').item.json.telefone }}\",\n  \"textMessage\": {\n    \"text\": \"üõí {{ $('Buscar Ofertas').item.json.message }}\\n\\n{{ $('Verificar Usu√°rio Existente').item.json[0].plano === 'trial' ? 'üÜì Trial ativo at√©: ' + $('Verificar Usu√°rio Existente').item.json[0].data_fim_trial.split('T')[0] : 'üíé Plano ' + $('Verificar Usu√°rio Existente').item.json[0].plano + ' ativo' }}\\n\\n---\\nüí° Digite *OFERTAS* para receber ofertas atualizadas!\"\n  }\n}\n",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -256,
        -672
      ],
      "id": "bc20f412-11fa-4766-866b-590bec0b7f95",
      "name": "Enviar Ofertas1",
      "credentials": {
        "httpHeaderAuth": {
          "id": "qFt2p2U8faEpGTz6",
          "name": "Credencial Evolution"
        }
      }
    },
    {
      "parameters": {
        "url": "http://evolution-api:8080/message/sendText/Dona Oferta",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"number\": \"{{ $('Processar Mensagem').item.json.telefone }}\",\n  \"textMessage\": {\n    \"text\": \"‚úÖ *Cadastro realizado com sucesso!*\\n\\nüéâ Bem-vindo √† Dona Oferta!\\n\\nüÜì *SEU TRIAL EST√Å ATIVO!*\\n‚Ä¢ 60 dias gratuitos\\n‚Ä¢ Ofertas ilimitadas\\n‚Ä¢ Sem custo algum\\n\\nüìÖ Trial v√°lido at√©: {{ $now.plus({ days: 60 }).toFormat('dd/MM/yyyy') }}\\n\\nüìã *Pr√≥xima etapa:* Vamos escolher seus supermercados preferidos.\\n\\nQual regi√£o voc√™ mora e quais supermercados frequenta?\\n\\nExemplo: *Moro em S√£o Paulo, frequento Carrefour e Extra*\\n\\nüí° Ap√≥s isso, voc√™ j√° pode receber ofertas digitando: *OFERTAS*\"\n  }\n}\n",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        16,
        -16
      ],
      "id": "37a0ddd7-7170-472f-9147-8629e4016e6b",
      "name": "Confirmar Cadastro1",
      "credentials": {
        "httpHeaderAuth": {
          "id": "qFt2p2U8faEpGTz6",
          "name": "Credencial Evolution"
        }
      }
    }
  ],
  "pinData": {},
  "connections": {
    "Webhook WhatsApp Interativo": {
      "main": [
        [
          {
            "node": "Processar Mensagem",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Processar Mensagem": {
      "main": [
        [
          {
            "node": "Verificar Usu√°rio Existente",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Verificar Usu√°rio Existente": {
      "main": [
        [
          {
            "node": "Usu√°rio Existe?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Usu√°rio Existe?": {
      "main": [
        [
          {
            "node": "Tem Supermercados?",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Iniciar Cadastro Novo",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Tem Supermercados?": {
      "main": [
        [
          {
            "node": "√â Comando Ofertas?",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Solicitar Supermercados",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "√â Comando Ofertas?": {
      "main": [
        [
          {
            "node": "Buscar Ofertas",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "√â Comando Plano?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "√â Comando Plano?": {
      "main": [
        [
          {
            "node": "Identificar Plano",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Resposta Gen√©rica1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Buscar Ofertas": {
      "main": [
        [
          {
            "node": "Enviar Ofertas1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Identificar Plano": {
      "main": [
        [
          {
            "node": "Chamar Gest√£o Planos",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Chamar Gest√£o Planos": {
      "main": [
        [
          {
            "node": "Resposta Webhook",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "√â Comando Cadastro?": {
      "main": [
        [
          {
            "node": "Extrair Dados Cadastro",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Resposta Gen√©rica1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Extrair Dados Cadastro": {
      "main": [
        [
          {
            "node": "Executar Cadastro",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Executar Cadastro": {
      "main": [
        [
          {
            "node": "Confirmar Cadastro1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Iniciar Cadastro Novo": {
      "main": [
        [
          {
            "node": "√â Comando Cadastro?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Solicitar Supermercados": {
      "main": [
        [
          {
            "node": "Resposta Webhook",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Resposta Gen√©rica1": {
      "main": [
        [
          {
            "node": "Resposta Webhook",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Enviar Ofertas1": {
      "main": [
        [
          {
            "node": "Resposta Webhook",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Confirmar Cadastro1": {
      "main": [
        [
          {
            "node": "Resposta Webhook",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": true,
  "settings": {
    "executionOrder": "v1"
  },
  "versionId": "37152c02-b15d-4b49-9459-cfb9f4f452fb",
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "272cce8fc0734a5b88fc72593c2bf0ac21199d31350ff75ad4c8ac06e3fa2f93"
  },
  "id": "1vzSQeWRZMLFr7Kn",
  "tags": []
}